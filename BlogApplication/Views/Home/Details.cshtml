@model Post 

<div class="container row p- rounded">
    <div class="col-6 bg-white p-5 rounded ">
        <h1>@Model.Title</h1>
        <div>
            @foreach (var tag in Model.Tags)
            {
                <a href="#" class="badge bg-primary bg-opacity-5 text-white mb-2 fw-bold">@tag.Name</a>
            }
        </div>
        <p>Yazan: @Model.User.Username</p>
        <p>Kategori: @Model.Category.Name</p>
        <div class="text-center">
            <img src="@Model.ImageURL" class="img-fluid rounded" alt=""/>
        </div>
        <br />
        <div>
            @Html.Raw(Model.ContentHTML)
        </div>
    </div>

    <div class="col-6 bg-white p-5 rounded border ">
        @if (ViewBag.CurrentUser != null)
        {
            <form method="post" asp-action="CreateComment">
                <div>
                    <h4 class="mb-3 text-center">Yorum Ekle</h4>
                    <input type="hidden" id="PostId" name="PostId" value="@Model.Id">
                    <div class="mb-3">
                        <textarea type="text" name="Text" id="Text" rows="3" class="form-control"></textarea>
                    </div>
                    <div class="mb-3 text-end">
                        <button id="btnYorumKayit" type="submit" class="btn btn-primary">Yorum Yap</button>
                    </div>
                </div>
            </form>
        }
        else
        {
            <p>Yorum yapmak için <a href="https://localhost:7114/Auth/Login">Login</a> olunuz. </p>
        }

        <div id="comments">
            @foreach (var comment in Model.Comments.Reverse())
            {
                <div class="row rounded border border-success p-2 mb-2">
                    <div class="col-8">
                        <div>
                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6e/Breezeicons-actions-22-im-user.svg/1200px-Breezeicons-actions-22-im-user.svg.png" class="avatar rounded-circle float-start me-3" style="height:110px;" alt="">
                        </div>
                        <div class="mt-3"></div>
                        <p class="fst-italic">@comment.User.Name @comment.User.Surname</p>
                        <p>@comment.Message</p>
                    </div>
                    <div class="col-4 position-relative">
                        <p>@comment.CreatedDateUTC</p>
                        @if (ViewBag.IsAdmin)
                        {
                            <button class="align-bottom-right btn btn-danger" style="position:absolute; right:0; bottom:0;" onclick="deleteComment(@comment.Id)">Sil</button>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
    <br />
</div>

@section Scripts {
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script type="text/javascript">

        var isAdmin = @Html.Raw(ViewBag.IsAdmin.ToString().ToLower());
        console.log('isAdmin:', isAdmin);
        $(document).ready(function(){
            $("#btnYorumKayit").click(function(){
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("CreateComment")',
                    dataType: 'json',
                    data: {
                        PostId: $('#PostId').val(),
                        Comment: $('#Text').val(),
                    },
                    success: function(response){
                        var commentsContainer = $("#comments");
                        commentsContainer.empty(); 

                        response.forEach(item => {
                            const date = new Date(item.createdDateUTC);
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            const hours = String(date.getHours()).padStart(2, '0');
                            const minutes = String(date.getMinutes()).padStart(2, '0');
                            const seconds = String(date.getSeconds()).padStart(2, '0');
                            const formattedDate = `${day}.${month}.${year} ${hours}:${minutes}:${seconds}`;

                            var commentDiv = $('<div class="row rounded border border-success p-2 mb-2"></div>');

                            var commentContent = 
                                `<div class="col-8">
                                    <div>
                                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6e/Breezeicons-actions-22-im-user.svg/1200px-Breezeicons-actions-22-im-user.svg.png" class="avatar rounded-circle float-start me-3" style="height:110px;" alt="">
                                    </div>
                                    <div class="mt-3"></div>
                                    <p class="fst-italic">${item.userFullName}</p>
                                    <p>${item.message}</p>
                                </div>
                                    <div class="col-4 position-relative">
                                        <p>${formattedDate}</p>`;

                                if (isAdmin) {
                                    commentContent += `<button class="align-bottom-right btn btn-danger" style="position:absolute; right:0; bottom:0;" onclick="deleteComment(${item.id})">Sil</button>`;
                                }
                                commentContent += `</div>`;
                            commentDiv.html(commentContent);
                            commentsContainer.append(commentDiv);
                        });

                        $('#Text').val('');
                    }
                });

                return false; 
            });
        });

        function deleteComment(commentId) {
            console.log('Deleting comment ID:', commentId);
            $.ajax({
                type: 'POST',
                url: '@Url.Action("DeleteComment")',
                dataType: 'json',
                data: {
                    commentId: commentId
                },
                success: function(response){
                    if (response.success) {
                        $("button[onclick='deleteComment(" + commentId + ")']").closest(".row").remove();
                    }
                }
            });
        }
        </script>
}